# <!-- @GENESIS_MODULE_START: phase31_epl_validation -->

from datetime import datetime\nfrom event_bus import EventBus
"""
üéØ PHASE 31 EPL FOCUSED VALIDATION TEST
=====================================
Quick validation of core PHASE 31 functionality
"""

import time
import datetime
from execution_prioritization_engine import ExecutionPrioritizationEngine
from hardened_event_bus import emit_event

def test_phase31_core_functionality():
    """Test core PHASE 31 EPL functionality"""
    print("üöÄ PHASE 31 EPL Core Functionality Test")
    print("=" * 50)
    
    # Initialize engine
    print("1. Initializing EPL engine...")
    epl = ExecutionPrioritizationEngine()
    print(f"‚úÖ EPL v{epl.version} initialized (Phase {epl.phase})")
    
    # Test priority calculation
    print("\n2. Testing priority calculation...")
    test_signals = [
        {"confidence": 0.9, "symbol": "EURUSD", "timestamp": time.time()},
        {"confidence": 0.7, "symbol": "GBPUSD", "timestamp": time.time()},
        {"confidence": 0.5, "symbol": "USDJPY", "timestamp": time.time()}
    ]
    
    for i, signal in enumerate(test_signals):
        score, tier = epl.calculate_priority_score(signal)
        print(f"   Signal {i+1}: confidence={signal['confidence']:.1f} ‚Üí score={score:.3f}, tier={tier}")
    
    # Test signal processing
    print("\n3. Testing signal processing...")
    test_signal = {
        "signal_id": "test_001",
        "symbol": "EURUSD",
        "direction": "BUY",
        "confidence": 0.85,
        "confluence_rating": 0.8,
        "amplified_confidence": 0.87,
        "entry_price": 1.0985,
        "stop_loss": 1.0965,
        "take_profit": 1.1025,
        "position_size_pct": 1.5,
        "volatility_context": 0.018,
        "timestamp": datetime.datetime.now().isoformat()
    }
    
    # Process through amplified signal handler
    try:
        epl._handle_amplified_signal(test_signal)
        print("‚úÖ Amplified signal processing successful")
    except Exception as e:
        print(f"‚ùå Amplified signal processing failed: {e}")
    
    # Test FTMO validation
    print("\n4. Testing FTMO compliance...")
    valid_signal = {"position_size_pct": 1.5, "symbol": "EURUSD"}
    invalid_signal = {"position_size_pct": 3.0, "symbol": "GBPUSD"}  # Exceeds 2% limit
    
    valid_result = epl._validate_ftmo_compliance(valid_signal)
    invalid_result = epl._validate_ftmo_compliance(invalid_signal)
    
    print(f"   Valid signal (1.5%): {valid_result}")
    print(f"   Invalid signal (3.0%): {invalid_result}")
    
    # Test market update
    print("\n5. Testing market adaptation...")
    market_update = {
        "volatility": 0.025,
        "regime": "volatile",
        "timestamp": time.time()
    }
    
    initial_regime = epl.current_market_regime
    epl._handle_market_update(market_update)
    
    print(f"   Market regime: {initial_regime} ‚Üí {epl.current_market_regime}")
    print(f"   Volatility: {epl.volatility_index}")
    
    # Get final status
    print("\n6. Engine status...")
    status = epl.get_status()
    print(f"   Signals processed: {status['signals_processed']}")
    print(f"   Queue depths: {status['queue_depths']}")
    print(f"   Telemetry: {len(status['telemetry'])} metrics tracked")
    
    print("\n‚úÖ PHASE 31 EPL Core Functionality Test COMPLETED")
    print("üéØ All core features operational and validated")
    
    return True

if __name__ == "__main__":
    test_phase31_core_functionality()


# <!-- @GENESIS_MODULE_END: phase31_epl_validation -->